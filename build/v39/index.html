<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="./favicon.png?v=5">
  <title>PMDF/BOPE - Fichas Criminais</title>
  <meta name="description" content="Fichas Criminais PMDF/BOPE - Bras√≠lia RP" />
  <meta name="author" content="PMDF/BOPE" />

  <meta property="og:title" content="PMDF/BOPE - Fichas Criminais" />
  <meta property="og:description" content="Fichas Criminais PMDF/BOPE - Bras√≠lia RP" />
  <meta property="og:type" content="website" />

  <script type="module" crossorigin src="/assets/index-Z5Ev_Ti-.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-DmCZH8oS.css">
</head>

<body>
  <div id="root"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // üîß Conex√£o com o seu projeto Supabase
    const supabaseUrl = 'https://mmfjhxxbjxrpgtxflti.supabase.co'; // corrigido
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZmpoeHhiamd4cnBndHhmbHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MzgyOTIsImV4cCI6MjA3ODMxNDI5Mn0.gImiWKxX6VyLxvA9Ex0vXtoD6348gIZM5LKiO3OAovI';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // üîÑ Canal em tempo real (Broadcast)
    const canal = supabase.channel('registros', {
      config: {
        broadcast: { self: true },
      },
    });

    // üöÄ Fun√ß√£o pra criar novo registro (envio + broadcast imediato)
    async function criarRegistro(dados) {
      adicionarRegistro(dados); // Mostra localmente de imediato

      // Envia pro Supabase
      const { error } = await supabase.from('registros').insert(dados);
      if (error) console.error('Erro ao inserir:', error);

      // Notifica os outros usu√°rios instantaneamente
      await canal.send({
        type: 'broadcast',
        event: 'novo-registro',
        payload: dados,
      });
    }

    // üëÅÔ∏è Escuta registros em tempo real via broadcast
    canal.on('broadcast', { event: 'novo-registro' }, (msg) => {
      adicionarRegistro(msg.payload);
    });

    // üëÇ Escuta tamb√©m via Postgres (garantia de sincroniza√ß√£o)
    supabase
      .channel('registros-db')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'registros' },
        (payload) => {
          console.log('Mudan√ßa detectada:', payload);

          if (payload.eventType === 'INSERT') {
            adicionarRegistro(payload.new);
          } else if (payload.eventType === 'UPDATE') {
            console.log('Registro atualizado:', payload.new);
          } else if (payload.eventType === 'DELETE') {
            console.log('Registro deletado:', payload.old);
          }
        }
      )
      .subscribe();

    // üß± Renderizar registros existentes ao abrir
    async function carregarRegistros() {
      const { data, error } = await supabase
        .from('registros') // verifique se esse √© o nome exato da tabela
        .select('*')
        .order('id', { ascending: false });

      if (error) {
        console.error('Erro ao carregar registros:', error);
        document.getElementById('root').innerHTML = '<p style="color:red;">Erro ao carregar registros.</p>';
        return;
      }

      mostrarRegistros(data);
    }

    // üí° Fun√ß√£o protegida contra data nula
    function mostrarRegistros(lista) {
      const root = document.getElementById('root');
      root.innerHTML = '';

      if (!lista || lista.length === 0) {
        root.innerHTML = '<p style="color:#aaa;text-align:center;margin-top:20px;">Nenhum registro encontrado.</p>';
        return;
      }

      lista.forEach(adicionarRegistro);
    }

    // üß© Fun√ß√£o para renderizar cada item
    function adicionarRegistro(item) {
      const root = document.getElementById('root');
      const div = document.createElement('div');
      div.classList.add('registro');
      div.innerHTML = `
        <strong>${item.nome}</strong> ‚Äî ${item.motivo} <br>
        üìç ${item.local} <br>
        <small>${new Date(item.created_at || Date.now()).toLocaleString()}</small>
        <hr>
      `;
      root.prepend(div);
    }

    carregarRegistros();
    canal.subscribe();

    // üß™ Bot√£o de teste opcional (pode remover)
    window.testarRegistro = () => {
      criarRegistro({
        nome: 'Teste Instant√¢neo',
        motivo: 'Verifica√ß√£o Broadcast',
        local: 'Painel PMDF',
        created_at: new Date().toISOString(),
      });
    };
  </script>
</body>
</html>
